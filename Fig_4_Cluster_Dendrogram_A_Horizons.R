# File Header -------------------------------------------------------------

# File Name: Fig_4_Cluster_Dendrogram_A_Horizons.R
# Created: January 17, 2020 by Tyler Weiglein
# Last Modified: October 28, 2021 by Tyler Weiglein

# Purpose: To generate Figure 4 (cluster dendrogram for A horizons). The 
# cluster dendrogram shows the relative correlation (using Spearman's 
# correlation coefficient) among the predictors selected by the Boruta 
# algorithm. These predictors are then grouped based on the "Elbow method."


# Preliminaries -----------------------------------------------------------

# Clear console and environment

cat("\014") 

rm(list = ls(all.names = TRUE))

# Load package(s)

library(Boruta)
library(factoextra)
library(ggplot2)
library(ggdendro)
library(mice)

# Set working directory

setwd("*Insert working directory path here*")

# Specify selection threshold

selection_threshold = 0.5


# Specify Imputed Predictor Data Sets -------------------------------------

# Read in mids objects corresponding to imputed predictor data sets

load("data_imp_CSR_0MST33_A_mids.RData")

# Create separate imputed data sets

for(i in 0:data_imp_CSR_0MST33_A_mids$m){

  data_set_name <- paste("data_imp_CSR_0MST33_A_", i, sep = "")
  assign(data_set_name, complete(data_imp_CSR_0MST33_A_mids, i))

}


# Separate Response from Predictors ---------------------------------------

# Response vectors

response_CSR_0MST33_A <- data_imp_CSR_0MST33_A_1$t52_cumul_spec_resp_ugC_per_gC

# Predictors data frames

predictors_A_1 <- data_imp_CSR_0MST33_A_1[, -(match("site", colnames(data_imp_CSR_0MST33_A_1)):match("t52_cumul_spec_resp_ugC_per_gC", colnames(data_imp_CSR_0MST33_A_1)))]
predictors_A_2 <- data_imp_CSR_0MST33_A_2[, -(match("site", colnames(data_imp_CSR_0MST33_A_2)):match("t52_cumul_spec_resp_ugC_per_gC", colnames(data_imp_CSR_0MST33_A_2)))]
predictors_A_3 <- data_imp_CSR_0MST33_A_3[, -(match("site", colnames(data_imp_CSR_0MST33_A_3)):match("t52_cumul_spec_resp_ugC_per_gC", colnames(data_imp_CSR_0MST33_A_3)))]
predictors_A_4 <- data_imp_CSR_0MST33_A_4[, -(match("site", colnames(data_imp_CSR_0MST33_A_4)):match("t52_cumul_spec_resp_ugC_per_gC", colnames(data_imp_CSR_0MST33_A_4)))]
predictors_A_5 <- data_imp_CSR_0MST33_A_5[, -(match("site", colnames(data_imp_CSR_0MST33_A_5)):match("t52_cumul_spec_resp_ugC_per_gC", colnames(data_imp_CSR_0MST33_A_5)))]


# Feature Selection w/ Boruta Algorithm -----------------------------------

# Specify key variables

seed = 1
max_num_runs = 1000

# Boruta algorithm using imputed data set 1

set.seed(seed)

Boruta_A_imp_1 <- Boruta(predictors_A_1,
                         response_CSR_0MST33_A,
                         maxRuns = max_num_runs)

# Boruta algorithm using imputed data set 2

set.seed(seed)

Boruta_A_imp_2 <- Boruta(predictors_A_2,
                         response_CSR_0MST33_A,
                         maxRuns = max_num_runs)

# Boruta algorithm using imputed data set 3

set.seed(seed)

Boruta_A_imp_3 <- Boruta(predictors_A_3,
                         response_CSR_0MST33_A,
                         maxRuns = max_num_runs)

# Boruta algorithm using imputed data set 4

set.seed(seed)

Boruta_A_imp_4 <- Boruta(predictors_A_4,
                         response_CSR_0MST33_A,
                         maxRuns = max_num_runs)

# Boruta algorithm using imputed data set 5

set.seed(seed)

Boruta_A_imp_5 <- Boruta(predictors_A_5,
                         response_CSR_0MST33_A,
                         maxRuns = max_num_runs)

# Get summary of Boruta algorithm output

importRank = seq(from = 1,
                 to = length(attStats(Boruta_A_imp_1)$meanImp),
                 by = 1)

summary_Boruta_A_imp_1 <- cbind(attStats(Boruta_A_imp_1)[order(attStats(Boruta_A_imp_1)$meanImp, decreasing = TRUE), ], importRank)
summary_Boruta_A_imp_2 <- cbind(attStats(Boruta_A_imp_2)[order(attStats(Boruta_A_imp_2)$meanImp, decreasing = TRUE), ], importRank)
summary_Boruta_A_imp_3 <- cbind(attStats(Boruta_A_imp_3)[order(attStats(Boruta_A_imp_3)$meanImp, decreasing = TRUE), ], importRank)
summary_Boruta_A_imp_4 <- cbind(attStats(Boruta_A_imp_4)[order(attStats(Boruta_A_imp_4)$meanImp, decreasing = TRUE), ], importRank)
summary_Boruta_A_imp_5 <- cbind(attStats(Boruta_A_imp_5)[order(attStats(Boruta_A_imp_5)$meanImp, decreasing = TRUE), ], importRank)

# Combine summary data: A horizons

var <- rownames(summary_Boruta_A_imp_1)

pctTimesSelected <- rep(NA, length(var))
meanImpMean <- rep(NA, length(var))
meanImportRank <- rep(NA, length(var))
pctImputed <- rep(NA, length(var))

for(i in 1:length(var)){
  
  i_1 <- match(var[i], rownames(summary_Boruta_A_imp_1))
  i_2 <- match(var[i], rownames(summary_Boruta_A_imp_2))
  i_3 <- match(var[i], rownames(summary_Boruta_A_imp_3))
  i_4 <- match(var[i], rownames(summary_Boruta_A_imp_4))
  i_5 <- match(var[i], rownames(summary_Boruta_A_imp_5))
  
  pctTimesSelected[i] <- sum(summary_Boruta_A_imp_1$decision[i_1] == "Confirmed",
                             summary_Boruta_A_imp_2$decision[i_2] == "Confirmed",
                             summary_Boruta_A_imp_3$decision[i_3] == "Confirmed",
                             summary_Boruta_A_imp_4$decision[i_4] == "Confirmed",
                             summary_Boruta_A_imp_5$decision[i_5] == "Confirmed")/5*100
  
  meanImpMean[i] <- sum(summary_Boruta_A_imp_1$meanImp[i_1],
                        summary_Boruta_A_imp_2$meanImp[i_2],
                        summary_Boruta_A_imp_3$meanImp[i_3],
                        summary_Boruta_A_imp_4$meanImp[i_4],
                        summary_Boruta_A_imp_5$meanImp[i_5])/5
  
  meanImportRank[i] <- sum(summary_Boruta_A_imp_1$importRank[i_1],
                           summary_Boruta_A_imp_2$importRank[i_2],
                           summary_Boruta_A_imp_3$importRank[i_3],
                           summary_Boruta_A_imp_4$importRank[i_4],
                           summary_Boruta_A_imp_5$importRank[i_5])/5
  
  pctImputed[i] = sum(is.na(data_imp_CSR_0MST33_A_0[[var[i]]]))/length(data_imp_CSR_0MST33_A_0[[var[i]]])*100
  
}

all_var_A <- data.frame(var,
                        pctTimesSelected,
                        meanImpMean,
                        meanImportRank,
                        pctImputed)

import_var_A <- subset(all_var_A, pctTimesSelected > 0)[order(subset(all_var_A, pctTimesSelected > 0)$meanImportRank), ]


# Correlation Cluster Dendrogram ------------------------------------------

# Create dendrograms for A horzion variables

data_1_A <- as.matrix(data_imp_CSR_0MST33_A_1[match(subset(import_var_A, pctTimesSelected > 50)$var, colnames(data_imp_CSR_0MST33_A_1))])
data_2_A <- as.matrix(data_imp_CSR_0MST33_A_2[match(subset(import_var_A, pctTimesSelected > 50)$var, colnames(data_imp_CSR_0MST33_A_2))])
data_3_A <- as.matrix(data_imp_CSR_0MST33_A_3[match(subset(import_var_A, pctTimesSelected > 50)$var, colnames(data_imp_CSR_0MST33_A_3))])
data_4_A <- as.matrix(data_imp_CSR_0MST33_A_4[match(subset(import_var_A, pctTimesSelected > 50)$var, colnames(data_imp_CSR_0MST33_A_4))])
data_5_A <- as.matrix(data_imp_CSR_0MST33_A_5[match(subset(import_var_A, pctTimesSelected > 50)$var, colnames(data_imp_CSR_0MST33_A_5))])

cor_dist_1_A <- (1 - abs(cor(data_1_A, method = "spearman")))
cor_dist_2_A <- (1 - abs(cor(data_2_A, method = "spearman")))
cor_dist_3_A <- (1 - abs(cor(data_3_A, method = "spearman")))
cor_dist_4_A <- (1 - abs(cor(data_4_A, method = "spearman")))
cor_dist_5_A <- (1 - abs(cor(data_5_A, method = "spearman")))

cor_dist_A_list <- list(cor_dist_1_A,
                        cor_dist_2_A,
                        cor_dist_3_A,
                        cor_dist_4_A,
                        cor_dist_5_A)

cor_mean_dist_A <- apply(simplify2array(cor_dist_A_list), 1:2, mean)

rownames(cor_mean_dist_A) <- c("Hargreaves climatic\nmoisture deficit",
                               "BTCA:lignin ratio\n(heavy fraction)",
                               "Ammonium oxalate\nextractable Fe",
                               "Ammonium oxalate\nextractable Al",
                               "MAP - Hargreaves\nreference evaporation",
                               "Sodium pyrophosphate\nextractable Fe",
                               "Annual heat:moisture index",
                               "Potassium chloride\nextractable Al",
                               "Syringyl phenols\nacid:aldehyde ratio",
                               "Summer heat:moisture index",
                               "BTCA:lignin ratio\n(bulk soil)",
                               "Dithionite-citrate\nextractable Al")

colnames(cor_mean_dist_A) <- c("Hargreaves climatic\nmoisture deficit",
                               "BTCA:lignin ratio\n(heavy fraction)",
                               "Ammonium oxalate\nextractable Fe",
                               "Ammonium oxalate\nextractable Al",
                               "MAP - Hargreaves\nreference evaporation",
                               "Sodium pyrophosphate\nextractable Fe",
                               "Annual heat:moisture index",
                               "Potassium chloride\nextractable Al",
                               "Syringyl phenols\nacid:aldehyde ratio",
                               "Summer heat:moisture index",
                               "BTCA:lignin ratio\n(bulk soil)",
                               "Dithionite-citrate\nextractable Al")

clust_A <- hclust(as.dist(cor_mean_dist_A), method = "complete")

ggdendrogram(clust_A, theme_dendro = FALSE) +
  scale_y_continuous(limits = c(0, 1), breaks = c(0, 0.5, 1)) +
  xlab("Predictors Selected by Boruta Algorithm") +
  ylab("Spearman Correlation Distance") +
  theme(panel.background = element_blank(),
        panel.border = element_blank(),
        panel.grid.major = element_blank(),
        axis.ticks.x = element_blank(),
        axis.title = element_text(face = "bold", size = 16),
        axis.title.x = element_text(margin = margin(t = 25)),
        axis.title.y = element_text(margin = margin(r = 10)),
        axis.text.x = element_text(vjust = 0.5, hjust = 1, margin = margin(t = -10), size = 14),
        axis.text.y = element_text(angle = 0, hjust = 0.5, size = 14))

# Verify number of clusters

fviz_nbclust(cor_mean_dist_A,
             FUN = hcut,
             method = "wss",
             k.max = length(colnames(cor_mean_dist_A)) - 1)
