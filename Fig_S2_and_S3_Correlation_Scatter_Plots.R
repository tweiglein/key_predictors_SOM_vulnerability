# File Header -------------------------------------------------------------

# File Name: Fig_S2_and_S3_Correlation_Scatter_Plots.R
# Created: July 22, 2020 by Tyler Weiglein
# Last Modified: October 28, 2021 by Tyler Weiglein

# Purpose: To create Figures S2 and S3 (scatter plots showing correlations 
# among selected predictors) for Supplementary Information section.


# Preliminaries -----------------------------------------------------------

# Clear console and environment

cat("\014") 

rm(list = ls(all.names = TRUE))

# Load package(s)

library(mice)
library(ggplot2)

# Set working directory

setwd("*Insert working directory path here*")

# Load data

load("data_imp_CSR_0MST33_A_mids.RData")
load("data_imp_CSR_0MST33_B_mids.RData")

# Extract non-imputed data

data_A <- complete(data_imp_CSR_0MST33_A_mids, 0)
data_B <- complete(data_imp_CSR_0MST33_B_mids, 0)

# Combine data

data <- rbind(data_A, data_B)

# Predictors selected by Boruta algorithm for A horizons

sel_pred_A <- c("MAP_Eref",
                "AHM",
                "SHM",
                "CMD",
                "Al_KCl.ugg_BULK",
                "SP_Fe.g100g_BULK",
                "AO_Fe.g100g_BULK",
                "AO_Al.g100g_BULK",
                "DC_Al.g100g_BULK",
                "BTC_LIG_BULK",
                "BTC_LIG_HF",
                "Sd_Sl_BULK")

sel_pred_B <- c("MAP_Eref",
                "AHM",
                "fresh_HWE_BULK",
                "MeanDBE_C_BULK",
                "CN.mol_BULK",
                "CN.mol_HF",
                "BTC_LIG_BULK")

sel_pred <- unique(c(sel_pred_A, sel_pred_B))


# Plots -------------------------------------------------------------------

# Correlation plots: A horizons

# Labels for selected predictors

labels_A <- c("MAP - Eref",
              "AHM",
              "SHM",
              "CMD",
              "KCl Al",
              "SP Fe",
              "AO Fe",
              "AO Al",
              "DC Al",
              "BTC:Lig\n(Bulk)",
              "BTC:Lig\n(HF)",
              "Sd:Sl")

# Correlation panel

panel.cor <- function(x, y){
  usr <- par("usr"); on.exit(par(usr))
  par(usr = c(0, 1, 0, 1))
  rho_cor <- formatC(cor.test(x, y, method = "spearman")$estimate, format = "f", digits = 2)
  pval <- formatC(cor.test(x, y, method = "spearman")$p.value, format = "e", digits = 2)
  if(as.numeric(pval) <= 0.05/((length(sel_pred_A)^2 - length(sel_pred_A))/2)){
    txt <- bquote(paste(rho, " = ", .(rho_cor)))
  }
  else{txt <- "N.S."}
  text(0.5, 0.5, txt, cex = 2)
}

# Customize upper panel
upper.panel <- function(x, y){
  points(x, y, pch = 19)
}

# Create plots

pairs(subset(data_A, select = sel_pred_A),
      labels = labels_A,
      cex.labels = 2,
      font.labels = 2,
      lower.panel = panel.cor,
      upper.panel = upper.panel)

# Correlation plots: B horizons

# Labels for selected predictors

labels_B <- c("MAP - Eref",
              "AHM",
              "HWE\nBIX",
              "CE\nDBE",
              "C:N\n(Bulk)",
              "C:N\n(HF)",
              "BTC:Lig")

# Correlation panel

panel.cor <- function(x, y){
  usr <- par("usr"); on.exit(par(usr))
  par(usr = c(0, 1, 0, 1))
  rho_cor <- formatC(cor.test(x, y, method = "spearman")$estimate, format = "f", digits = 2)
  pval <- formatC(cor.test(x, y, method = "spearman")$p.value, format = "e", digits = 2)
  if(as.numeric(pval) <= 0.05/((length(sel_pred_B)^2 - length(sel_pred_B))/2)){
    txt <- bquote(paste(rho, " = ", .(rho_cor)))
  }
  else{txt <- "N.S."}
  text(0.5, 0.5, txt, cex = 2)
}

# Customize upper panel

upper.panel <- function(x, y){
  points(x, y, pch = 19)
}

# Create plots

pairs(subset(data_B, select = sel_pred_B),
      labels = labels_B,
      cex.labels = 2,
      font.labels = 2,
      lower.panel = panel.cor,
      upper.panel = upper.panel)
