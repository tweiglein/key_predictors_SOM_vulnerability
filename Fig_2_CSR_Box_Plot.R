# File Header -------------------------------------------------------------

# File Name: Fig_2_CSR_Box_Plot.R
# Created: January 18, 2020 by Tyler Weiglein
# Last Modified: April 09, 2021 by Tyler Weiglein

# Purpose: To generate Figure 2 (CSR box plot) for incubation CSR manuscript. 
# The box plot shows the relative magnitude of CSR for both A and B horizons 
# for the following time periods: 0-52 weeks, 0-26 weeks, and 26-52 weeks.


# Preliminaries -----------------------------------------------------------

# Clear console and environment

cat("\014") 

rm(list = ls(all.names = TRUE))

# Load package(s)

library(car)
library(tidyverse)

# Set working directory

setwd("*Insert working directory path here*")

# Read in CSR data

data <- read.csv("data.csv")


# Hypothesis Testing ------------------------------------------------------

## CSR 0-52 weeks

# Check assumptions - A horizons

qqnorm(subset(data, horizon_type %in% "A-Horizon")$t52_cumul_spec_resp_ugC_per_gC,
       pch = 20,
       main = "Normal Q-Q Plot: A CSR 0 to 52 wks")
qqline(subset(data, horizon_type %in% "A-Horizon")$t52_cumul_spec_resp_ugC_per_gC,
       col = "red",
       lwd = 2)

# A horizon CSR values generally follow a normal distribution.

# Check assumptions - B Horizons

qqnorm(subset(data, horizon_type %in% "Upper B-Horizon")$t52_cumul_spec_resp_ugC_per_gC,
       pch = 20,
       main = "Normal Q-Q Plot: B CSR 0 to 52 wks")
qqline(subset(data, horizon_type %in% "Upper B-Horizon")$t52_cumul_spec_resp_ugC_per_gC,
       col = "red",
       lwd = 2)

# B horizon CSR values do not follow a normal distribution.

# Will have to use paired non-parametric test (e.g., Wilcoxon signed rank test)

# Test for equal variances

leveneTest(subset(data, incubation %in% "0MST33")$t52_cumul_spec_resp_ugC_per_gC, group = subset(data, incubation %in% "0MST33")$horizon_type)

# Given that p = 0.7263, equal variances assumption met.

CSR_0_52_test <- wilcox.test(subset(data, horizon_type %in% "A-Horizon")$t52_cumul_spec_resp_ugC_per_gC,
                             subset(data, horizon_type %in% "Upper B-Horizon")$t52_cumul_spec_resp_ugC_per_gC,
                             paired = TRUE)

print(CSR_0_52_test)

# Given that p = 0.01295, it can be concluded that the median CSR value is different between the two types of horizons.

## CSR 0-26 weeks

# Check assumptions - A horizons

qqnorm(subset(data, horizon_type %in% "A-Horizon")$t26_cumul_spec_resp_ugC_per_gC,
       pch = 20,
       main = "Normal Q-Q Plot: A CSR 0 to 26 wks")
qqline(subset(data, horizon_type %in% "A-Horizon")$t26_cumul_spec_resp_ugC_per_gC,
       col = "red",
       lwd = 2)

# A horizon CSR values generally follow a normal distribution.

# Check assumptions - B Horizons

qqnorm(subset(data, horizon_type %in% "Upper B-Horizon")$t26_cumul_spec_resp_ugC_per_gC,
       pch = 20,
       main = "Normal Q-Q Plot: B CSR 0 to 26 wks")
qqline(subset(data, horizon_type %in% "Upper B-Horizon")$t26_cumul_spec_resp_ugC_per_gC,
       col = "red",
       lwd = 2)

# B horizon CSR values do not follow a normal distribution.

# Will have to use paired non-parametric test (e.g., Wilcoxon signed rank test)

# Test for equal variances

leveneTest(subset(data, incubation %in% "0MST33")$t26_cumul_spec_resp_ugC_per_gC, group = subset(data, incubation %in% "0MST33")$horizon_type)

# Given that p = 0.4931, equal variances assumption met.

CSR_0_26_test <- wilcox.test(subset(data, horizon_type %in% "A-Horizon")$t26_cumul_spec_resp_ugC_per_gC,
                             subset(data, horizon_type %in% "Upper B-Horizon")$t26_cumul_spec_resp_ugC_per_gC,
                             paired = TRUE)

print(CSR_0_26_test)

# Given that p = 0.001972, it can be concluded that the median CSR value is different between the two types of horizons.

## CSR 26-52 weeks

# Check assumptions - A horizons

qqnorm(subset(data, horizon_type %in% "A-Horizon")$diff_t52_t26_cumul_spec_resp_ugC_per_gC,
       pch = 20,
       main = "Normal Q-Q Plot: A CSR 26 to 52 wks")
qqline(subset(data, horizon_type %in% "A-Horizon")$diff_t52_t26_cumul_spec_resp_ugC_per_gC,
       col = "red",
       lwd = 2)

# A horizon CSR values do not follow a normal distribution.

# Check assumptions - B Horizons

qqnorm(subset(data, horizon_type %in% "Upper B-Horizon")$diff_t52_t26_cumul_spec_resp_ugC_per_gC,
       pch = 20,
       main = "Normal Q-Q Plot: B CSR 26 to 52 wks")
qqline(subset(data, horizon_type %in% "Upper B-Horizon")$diff_t52_t26_cumul_spec_resp_ugC_per_gC,
       col = "red",
       lwd = 2)

# B horizon CSR values do not follow normal distribution.

# Will have to use paired non-parametric test (e.g., Wilcoxon signed rank test)

# Test for equal variances

leveneTest(subset(data, incubation %in% "0MST33")$diff_t52_t26_cumul_spec_resp_ugC_per_gC, group = subset(data, incubation %in% "0MST33")$horizon_type)

# Given that p = 0.8757, equal variances assumption met.

CSR_26_52_test <- wilcox.test(subset(data, horizon_type %in% "A-Horizon")$diff_t52_t26_cumul_spec_resp_ugC_per_gC,
                              subset(data, horizon_type %in% "Upper B-Horizon")$diff_t52_t26_cumul_spec_resp_ugC_per_gC,
                              paired = TRUE)

print(CSR_26_52_test)

# Given that p = 0.7078, it can be concluded that the median CSR value is different between the two types of horizons.


# Box Plot ----------------------------------------------------------------

# Assign data

time_period <- factor(c(rep("0_52", length(data$site)),
                        rep("0_26", length(data$site)),
                        rep("26_52", length(data$site))),
                      levels = c("0_52", "0_26", "26_52"), ordered = TRUE)

horizon_type <- factor(c(as.character(data$horizon_type),
                         as.character(data$horizon_type),
                         as.character(data$horizon_type)))

CSR <- c(data$t52_cumul_spec_resp_ugC_per_gC/10^6*100,
         data$t26_cumul_spec_resp_ugC_per_gC/10^6*100,
         data$diff_t52_t26_cumul_spec_resp_ugC_per_gC/10^6*100)

CSR_df <- data.frame(time_period, horizon_type, CSR)

CSR_box_plot <- ggplot(data = CSR_df,
                       mapping = aes(x = time_period, y = CSR, fill = horizon_type))

# Create box plot

plot <- CSR_box_plot + 
  stat_boxplot(geom = "errorbar") +
  geom_boxplot() +
  geom_vline(xintercept = 1.5, size = 0.25) +
  xlab("Time Period") +
  ylab("Cumulative Specific Respiration\n(% SOC Respired)") + 
  scale_x_discrete(labels = c("0 - 52\nweeks", "0 - 26\nweeks", "26 - 52\nweeks")) + 
  scale_fill_discrete(name = "Horizon Type", labels = c("A Horizon", "B Horizon")) +
  geom_text(x = 1, y = 20, label = paste0("p-value = ", format(round(CSR_0_52_test$p.value, 3), nsmall = 3)), size = 6) + 
  geom_text(x = 2, y = 20, label = paste0("p-value = ", format(round(CSR_0_26_test$p.value, 3), nsmall = 3)), size = 6) + 
  geom_text(x = 3, y = 20, label = paste0("p-value = ", format(round(CSR_26_52_test$p.value, 3), nsmall = 3)), size = 6) + 
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.title.x = element_text(face = "bold", size = 24, margin = margin(t = 25)),
        axis.title.y = element_text(face = "bold", size = 24, margin = margin(r = 15)),
        axis.text.x = element_text(color = "black", size = 18),
        axis.text.y = element_text(color = "black", size = 18),
        legend.title = element_text(face = "bold", size = 24),
        legend.text = element_text(size = 18))

