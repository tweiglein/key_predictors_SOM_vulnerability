# File Header -------------------------------------------------------------

# File Name: Boruta_Cluster_CSR_t_0_52_wks.R
# Created: November 04, 2019 by Tyler Weiglein
# Last Modified: April 09, 2021 by Tyler Weiglein

# Purpose: To use the Boruta algorithm to determine important predictors
# of CSR and to cluster the predictors based on correlation.

# Data analysis code should be run in the following order:
# 1) Data_Imputation.R
# 2) Boruta_Cluster_CSR_t_0_52_wks.R


# Preliminaries -----------------------------------------------------------

# Clear console and environment

cat("\014") 

rm(list = ls(all.names = TRUE))

# Load package(s)

library(mice)
library(Boruta)
library(factoextra)
library(cluster)
library(NbClust)
library(openxlsx)

# Set working directory

setwd("*Insert working directory path here*")

# Specify selection threshold (fraction of imputed data sets for which a given predictor must be selected to be considered important)

selection_threshold = 0.5


# Specify Imputed Predictor Data Sets -------------------------------------

# Read in mids objects corresponding to imputed predictor data sets

load("data_imp_CSR_0MST33_A_mids.RData")
load("data_imp_CSR_0MST33_B_mids.RData")

# Create separate imputed data sets

for(i in 0:data_imp_CSR_0MST33_A_mids$m){
  
  data_set_name <- paste("data_imp_CSR_0MST33_A_", i, sep = "")
  assign(data_set_name, complete(data_imp_CSR_0MST33_A_mids, i))
  
}

for(i in 0:data_imp_CSR_0MST33_B_mids$m){
  
  data_set_name <- paste("data_imp_CSR_0MST33_B_", i, sep = "")
  assign(data_set_name, complete(data_imp_CSR_0MST33_B_mids, i))
  
}


# Separate Response from Predictors ---------------------------------------

# Response vectors

response_CSR_0MST33_A <- data_imp_CSR_0MST33_A_0$t52_cumul_spec_resp_ugC_per_gC
response_CSR_0MST33_B <- data_imp_CSR_0MST33_B_0$t52_cumul_spec_resp_ugC_per_gC

# Predictors data frames

predictors_A_1 <- data_imp_CSR_0MST33_A_1[, -(match("site", colnames(data_imp_CSR_0MST33_A_1)):match("t52_cumul_spec_resp_ugC_per_gC", colnames(data_imp_CSR_0MST33_A_1)))]
predictors_A_2 <- data_imp_CSR_0MST33_A_2[, -(match("site", colnames(data_imp_CSR_0MST33_A_2)):match("t52_cumul_spec_resp_ugC_per_gC", colnames(data_imp_CSR_0MST33_A_2)))]
predictors_A_3 <- data_imp_CSR_0MST33_A_3[, -(match("site", colnames(data_imp_CSR_0MST33_A_3)):match("t52_cumul_spec_resp_ugC_per_gC", colnames(data_imp_CSR_0MST33_A_3)))]
predictors_A_4 <- data_imp_CSR_0MST33_A_4[, -(match("site", colnames(data_imp_CSR_0MST33_A_4)):match("t52_cumul_spec_resp_ugC_per_gC", colnames(data_imp_CSR_0MST33_A_4)))]
predictors_A_5 <- data_imp_CSR_0MST33_A_5[, -(match("site", colnames(data_imp_CSR_0MST33_A_5)):match("t52_cumul_spec_resp_ugC_per_gC", colnames(data_imp_CSR_0MST33_A_5)))]

predictors_B_1 <- data_imp_CSR_0MST33_B_1[, -(match("site", colnames(data_imp_CSR_0MST33_B_1)):match("t52_cumul_spec_resp_ugC_per_gC", colnames(data_imp_CSR_0MST33_B_1)))]
predictors_B_2 <- data_imp_CSR_0MST33_B_2[, -(match("site", colnames(data_imp_CSR_0MST33_B_2)):match("t52_cumul_spec_resp_ugC_per_gC", colnames(data_imp_CSR_0MST33_B_2)))]
predictors_B_3 <- data_imp_CSR_0MST33_B_3[, -(match("site", colnames(data_imp_CSR_0MST33_B_3)):match("t52_cumul_spec_resp_ugC_per_gC", colnames(data_imp_CSR_0MST33_B_3)))]
predictors_B_4 <- data_imp_CSR_0MST33_B_4[, -(match("site", colnames(data_imp_CSR_0MST33_B_4)):match("t52_cumul_spec_resp_ugC_per_gC", colnames(data_imp_CSR_0MST33_B_4)))]
predictors_B_5 <- data_imp_CSR_0MST33_B_5[, -(match("site", colnames(data_imp_CSR_0MST33_B_5)):match("t52_cumul_spec_resp_ugC_per_gC", colnames(data_imp_CSR_0MST33_B_5)))]


# Variable Abbreviations and Names ----------------------------------------

var_abbrev_names <- read.xlsx("Var_Abbreviations_Names.xlsx")


# Feature Selection w/ Boruta Algorithm -----------------------------------

# Specify key variables

seed = 1
max_num_runs = 1000

# Boruta algorithm using imputed data set 1

set.seed(seed)

Boruta_A_imp_1 <- Boruta(predictors_A_1,
                         response_CSR_0MST33_A,
                         maxRuns = max_num_runs)
  
set.seed(seed)

Boruta_B_imp_1 <- Boruta(predictors_B_1,
                         response_CSR_0MST33_B,
                         maxRuns = max_num_runs)

# Boruta algorithm using imputed data set 2

set.seed(seed)

Boruta_A_imp_2 <- Boruta(predictors_A_2,
                         response_CSR_0MST33_A,
                         maxRuns = max_num_runs)

set.seed(seed)

Boruta_B_imp_2 <- Boruta(predictors_B_2,
                         response_CSR_0MST33_B,
                         maxRuns = max_num_runs)
                    
# Boruta algorithm using imputed data set 3

set.seed(seed)

Boruta_A_imp_3 <- Boruta(predictors_A_3,
                         response_CSR_0MST33_A,
                         maxRuns = max_num_runs)

set.seed(seed)

Boruta_B_imp_3 <- Boruta(predictors_B_3,
                         response_CSR_0MST33_B,
                         maxRuns = max_num_runs)

# Boruta algorithm using imputed data set 4

set.seed(seed)

Boruta_A_imp_4 <- Boruta(predictors_A_4,
                         response_CSR_0MST33_A,
                         maxRuns = max_num_runs)

set.seed(seed)

Boruta_B_imp_4 <- Boruta(predictors_B_4,
                         response_CSR_0MST33_B,
                         maxRuns = max_num_runs)

# Boruta algorithm using imputed data set 5

set.seed(seed)

Boruta_A_imp_5 <- Boruta(predictors_A_5,
                         response_CSR_0MST33_A,
                         maxRuns = max_num_runs)

set.seed(seed)

Boruta_B_imp_5 <- Boruta(predictors_B_5,
                         response_CSR_0MST33_B,
                         maxRuns = max_num_runs)

# Create plots from Boruta algorithm output

# Imputation 1

pdf("Boruta Plots/Boruta_CSR_A_imp_1.pdf",
    width = 11,
    height = 8.5)

par(mar = c(8, 4, 4, 2) + 0.1)

plot(Boruta_A_imp_1, xlab = "", ylab = "", yaxt = "n", las = 2, cex.axis = 0.5)
axis(2)
mtext(expression(bold("Attributes")), side = 1, line = 6.5)
mtext(expression(bold("Importance")), side = 2, line = 2)

dev.off()

pdf("Boruta Plots/Boruta_CSR_B_imp_1.pdf",
    width = 11,
    height = 8.5)

par(mar = c(8, 4, 4, 2) + 0.1)

plot(Boruta_B_imp_1, xlab = "", ylab = "", yaxt = "n", las = 2, cex.axis = 0.5)
axis(2)
mtext(expression(bold("Attributes")), side = 1, line = 6.5)
mtext(expression(bold("Importance")), side = 2, line = 2)

dev.off()

# Imputation 2

pdf("Boruta Plots/Boruta_CSR_A_imp_2.pdf",
    width = 11,
    height = 8.5)

par(mar = c(8, 4, 4, 2) + 0.1)

plot(Boruta_A_imp_2, xlab = "", ylab = "", yaxt = "n", las = 2, cex.axis = 0.5)
axis(2)
mtext(expression(bold("Attributes")), side = 1, line = 6.5)
mtext(expression(bold("Importance")), side = 2, line = 2)

dev.off()

pdf("Boruta Plots/Boruta_CSR_B_imp_2.pdf",
    width = 11,
    height = 8.5)

par(mar = c(8, 4, 4, 2) + 0.1)

plot(Boruta_B_imp_2, xlab = "", ylab = "", yaxt = "n", las = 2, cex.axis = 0.5)
axis(2)
mtext(expression(bold("Attributes")), side = 1, line = 6.5)
mtext(expression(bold("Importance")), side = 2, line = 2)

dev.off()

# Imputation 3

pdf("Boruta Plots/Boruta_CSR_A_imp_3.pdf",
    width = 11,
    height = 8.5)

par(mar = c(8, 4, 4, 2) + 0.1)

plot(Boruta_A_imp_3, xlab = "", ylab = "", yaxt = "n", las = 2, cex.axis = 0.5)
axis(2)
mtext(expression(bold("Attributes")), side = 1, line = 6.5)
mtext(expression(bold("Importance")), side = 2, line = 2)

dev.off()

pdf("Boruta Plots/Boruta_CSR_B_imp_3.pdf",
    width = 11,
    height = 8.5)

par(mar = c(8, 4, 4, 2) + 0.1)

plot(Boruta_B_imp_3, xlab = "", ylab = "", yaxt = "n", las = 2, cex.axis = 0.5)
axis(2)
mtext(expression(bold("Attributes")), side = 1, line = 6.5)
mtext(expression(bold("Importance")), side = 2, line = 2)

dev.off()

# Imputation 4

pdf("Boruta Plots/Boruta_CSR_A_imp_4.pdf",
    width = 11,
    height = 8.5)

par(mar = c(8, 4, 4, 2) + 0.1)

plot(Boruta_A_imp_4, xlab = "", ylab = "", yaxt = "n", las = 2, cex.axis = 0.5)
axis(2)
mtext(expression(bold("Attributes")), side = 1, line = 6.5)
mtext(expression(bold("Importance")), side = 2, line = 2)

dev.off()

pdf("Boruta Plots/Boruta_CSR_B_imp_4.pdf",
    width = 11,
    height = 8.5)

par(mar = c(8, 4, 4, 2) + 0.1)

plot(Boruta_B_imp_4, xlab = "", ylab = "", yaxt = "n", las = 2, cex.axis = 0.5)
axis(2)
mtext(expression(bold("Attributes")), side = 1, line = 6.5)
mtext(expression(bold("Importance")), side = 2, line = 2)

dev.off()

# Imputation 5

pdf("Boruta Plots/Boruta_CSR_A_imp_5.pdf",
    width = 11,
    height = 8.5)

par(mar = c(8, 4, 4, 2) + 0.1)

plot(Boruta_A_imp_5, xlab = "", ylab = "", yaxt = "n", las = 2, cex.axis = 0.5)
axis(2)
mtext(expression(bold("Attributes")), side = 1, line = 6.5)
mtext(expression(bold("Importance")), side = 2, line = 2)

dev.off()

pdf("Boruta Plots/Boruta_CSR_B_imp_5.pdf",
    width = 11,
    height = 8.5)

par(mar = c(8, 4, 4, 2) + 0.1)

plot(Boruta_B_imp_5, xlab = "", ylab = "", yaxt = "n", las = 2, cex.axis = 0.5)
axis(2)
mtext(expression(bold("Attributes")), side = 1, line = 6.5)
mtext(expression(bold("Importance")), side = 2, line = 2)

dev.off()

# Get summary of Boruta algorithm output

importRank = seq(from = 1,
                   to = length(attStats(Boruta_A_imp_1)$meanImp),
                   by = 1)

summary_Boruta_A_imp_1 <- cbind(attStats(Boruta_A_imp_1)[order(attStats(Boruta_A_imp_1)$meanImp, decreasing = TRUE), ], importRank)
summary_Boruta_A_imp_2 <- cbind(attStats(Boruta_A_imp_2)[order(attStats(Boruta_A_imp_2)$meanImp, decreasing = TRUE), ], importRank)
summary_Boruta_A_imp_3 <- cbind(attStats(Boruta_A_imp_3)[order(attStats(Boruta_A_imp_3)$meanImp, decreasing = TRUE), ], importRank)
summary_Boruta_A_imp_4 <- cbind(attStats(Boruta_A_imp_4)[order(attStats(Boruta_A_imp_4)$meanImp, decreasing = TRUE), ], importRank)
summary_Boruta_A_imp_5 <- cbind(attStats(Boruta_A_imp_5)[order(attStats(Boruta_A_imp_5)$meanImp, decreasing = TRUE), ], importRank)

summary_Boruta_B_imp_1 <- cbind(attStats(Boruta_B_imp_1)[order(attStats(Boruta_B_imp_1)$meanImp, decreasing = TRUE), ], importRank)
summary_Boruta_B_imp_2 <- cbind(attStats(Boruta_B_imp_2)[order(attStats(Boruta_B_imp_2)$meanImp, decreasing = TRUE), ], importRank)
summary_Boruta_B_imp_3 <- cbind(attStats(Boruta_B_imp_3)[order(attStats(Boruta_B_imp_3)$meanImp, decreasing = TRUE), ], importRank)
summary_Boruta_B_imp_4 <- cbind(attStats(Boruta_B_imp_4)[order(attStats(Boruta_B_imp_4)$meanImp, decreasing = TRUE), ], importRank)
summary_Boruta_B_imp_5 <- cbind(attStats(Boruta_B_imp_5)[order(attStats(Boruta_B_imp_5)$meanImp, decreasing = TRUE), ], importRank)

# Combine summary data: A horizons

var <- rownames(summary_Boruta_A_imp_1)

pctTimesSelected <- rep(NA, length(var))
meanImpMean <- rep(NA, length(var))
meanImportRank <- rep(NA, length(var))
pctImputed <- rep(NA, length(var))

for(i in 1:length(var)){
  
  i_1 <- match(var[i], rownames(summary_Boruta_A_imp_1))
  i_2 <- match(var[i], rownames(summary_Boruta_A_imp_2))
  i_3 <- match(var[i], rownames(summary_Boruta_A_imp_3))
  i_4 <- match(var[i], rownames(summary_Boruta_A_imp_4))
  i_5 <- match(var[i], rownames(summary_Boruta_A_imp_5))
  
  pctTimesSelected[i] <- sum(summary_Boruta_A_imp_1$decision[i_1] == "Confirmed",
                             summary_Boruta_A_imp_2$decision[i_2] == "Confirmed",
                             summary_Boruta_A_imp_3$decision[i_3] == "Confirmed",
                             summary_Boruta_A_imp_4$decision[i_4] == "Confirmed",
                             summary_Boruta_A_imp_5$decision[i_5] == "Confirmed")/5*100
  
  meanImpMean[i] <- sum(summary_Boruta_A_imp_1$meanImp[i_1],
                        summary_Boruta_A_imp_2$meanImp[i_2],
                        summary_Boruta_A_imp_3$meanImp[i_3],
                        summary_Boruta_A_imp_4$meanImp[i_4],
                        summary_Boruta_A_imp_5$meanImp[i_5])/5
  
  meanImportRank[i] <- sum(summary_Boruta_A_imp_1$importRank[i_1],
                           summary_Boruta_A_imp_2$importRank[i_2],
                           summary_Boruta_A_imp_3$importRank[i_3],
                           summary_Boruta_A_imp_4$importRank[i_4],
                           summary_Boruta_A_imp_5$importRank[i_5])/5
  
  pctImputed[i] = sum(is.na(data_imp_CSR_0MST33_A_0[[var[i]]]))/length(data_imp_CSR_0MST33_A_0[[var[i]]])*100
  
}

var_names <- var_abbrev_names$var_name[match(var, var_abbrev_names$var_abbrev)]

all_var_A <- data.frame(var,
                        var_names,
                        pctTimesSelected,
                        meanImpMean,
                        meanImportRank,
                        pctImputed)

all_var_A <- all_var_A[order(all_var_A$meanImportRank, decreasing = FALSE), ]

write.xlsx(all_var_A, file = "all_var_table_CSR_A.xlsx", asTable = FALSE)

import_var_A <- subset(all_var_A, pctTimesSelected > 0)[order(subset(all_var_A, pctTimesSelected > 0)$meanImportRank), ]

write.csv(subset(import_var_A, pctTimesSelected > selection_threshold*100)$var, file = "import_var_CSR_A.csv", row.names = FALSE)

write.xlsx(subset(import_var_A, pctTimesSelected > selection_threshold*100), file = "import_var_table_CSR_A.xlsx", asTable = FALSE)

# Combine summary data: B horizons

var <- rownames(summary_Boruta_B_imp_1)

pctTimesSelected <- rep(NA, length(var))
meanImpMean <- rep(NA, length(var))
meanImportRank <- rep(NA, length(var))
pctImputed <- rep(NA, length(var))

for(i in 1:length(var)){
  
  i_1 <- match(var[i], rownames(summary_Boruta_B_imp_1))
  i_2 <- match(var[i], rownames(summary_Boruta_B_imp_2))
  i_3 <- match(var[i], rownames(summary_Boruta_B_imp_3))
  i_4 <- match(var[i], rownames(summary_Boruta_B_imp_4))
  i_5 <- match(var[i], rownames(summary_Boruta_B_imp_5))
  
  pctTimesSelected[i] <- sum(summary_Boruta_B_imp_1$decision[i_1] == "Confirmed",
                             summary_Boruta_B_imp_2$decision[i_2] == "Confirmed",
                             summary_Boruta_B_imp_3$decision[i_3] == "Confirmed",
                             summary_Boruta_B_imp_4$decision[i_4] == "Confirmed",
                             summary_Boruta_B_imp_5$decision[i_5] == "Confirmed")/5*100
  
  meanImpMean[i] <- sum(summary_Boruta_B_imp_1$meanImp[i_1],
                        summary_Boruta_B_imp_2$meanImp[i_2],
                        summary_Boruta_B_imp_3$meanImp[i_3],
                        summary_Boruta_B_imp_4$meanImp[i_4],
                        summary_Boruta_B_imp_5$meanImp[i_5])/5
  
  meanImportRank[i] <- sum(summary_Boruta_B_imp_1$importRank[i_1],
                           summary_Boruta_B_imp_2$importRank[i_2],
                           summary_Boruta_B_imp_3$importRank[i_3],
                           summary_Boruta_B_imp_4$importRank[i_4],
                           summary_Boruta_B_imp_5$importRank[i_5])/5
  
  pctImputed[i] = sum(is.na(data_imp_CSR_0MST33_B_0[[var[i]]]))/length(data_imp_CSR_0MST33_B_0[[var[i]]])*100
  
}

var_names <- var_abbrev_names$var_name[match(var, var_abbrev_names$var_abbrev)]

all_var_B <- data.frame(var,
                        var_names,
                        pctTimesSelected,
                        meanImpMean,
                        meanImportRank,
                        pctImputed)

all_var_B <- all_var_B[order(all_var_B$meanImportRank, decreasing = FALSE), ]

write.xlsx(all_var_B, file = "all_var_table_CSR_B.xlsx", asTable = FALSE)

import_var_B <- subset(all_var_B, pctTimesSelected > 0)[order(subset(all_var_B, pctTimesSelected > 0)$meanImportRank), ]

write.csv(subset(import_var_B, pctTimesSelected > selection_threshold*100)$var, file = "import_var_CSR_B.csv", row.names = FALSE)

write.xlsx(subset(import_var_B, pctTimesSelected > selection_threshold*100), file = "import_var_table_CSR_B.xlsx", asTable = FALSE)


# Correlation Cluster Dendrograms -----------------------------------------

# Create dendrograms for A horzion variables

data_1_A <- as.matrix(data_imp_CSR_0MST33_A_1[match(subset(import_var_A, pctTimesSelected > 50)$var, colnames(data_imp_CSR_0MST33_A_1))])
data_2_A <- as.matrix(data_imp_CSR_0MST33_A_2[match(subset(import_var_A, pctTimesSelected > 50)$var, colnames(data_imp_CSR_0MST33_A_2))])
data_3_A <- as.matrix(data_imp_CSR_0MST33_A_3[match(subset(import_var_A, pctTimesSelected > 50)$var, colnames(data_imp_CSR_0MST33_A_3))])
data_4_A <- as.matrix(data_imp_CSR_0MST33_A_4[match(subset(import_var_A, pctTimesSelected > 50)$var, colnames(data_imp_CSR_0MST33_A_4))])
data_5_A <- as.matrix(data_imp_CSR_0MST33_A_5[match(subset(import_var_A, pctTimesSelected > 50)$var, colnames(data_imp_CSR_0MST33_A_5))])

cor_dist_1_A <- (1 - abs(cor(data_1_A, method = "spearman")))
cor_dist_2_A <- (1 - abs(cor(data_2_A, method = "spearman")))
cor_dist_3_A <- (1 - abs(cor(data_3_A, method = "spearman")))
cor_dist_4_A <- (1 - abs(cor(data_4_A, method = "spearman")))
cor_dist_5_A <- (1 - abs(cor(data_5_A, method = "spearman")))

cor_dist_A_list <- list(cor_dist_1_A,
                        cor_dist_2_A,
                        cor_dist_3_A,
                        cor_dist_4_A,
                        cor_dist_5_A)

cor_mean_dist_A <- apply(simplify2array(cor_dist_A_list), 1:2, mean)

clust_A <- hclust(as.dist(cor_mean_dist_A), method = "complete")

plot(clust_A, main = "Cluster Dendrogram: A Horizons")

rect.hclust(clust_A, k = 3, border = 2:5)

# Verify number of clusters

fviz_nbclust(cor_mean_dist_A,
             FUN = hcut,
             method = "wss",
             k.max = length(colnames(cor_mean_dist_A)) - 1)


# Create dendrograms for B horzion variables

data_1_B <- as.matrix(data_imp_CSR_0MST33_B_1[match(subset(import_var_B, pctTimesSelected > 50)$var, colnames(data_imp_CSR_0MST33_B_1))])
data_2_B <- as.matrix(data_imp_CSR_0MST33_B_2[match(subset(import_var_B, pctTimesSelected > 50)$var, colnames(data_imp_CSR_0MST33_B_2))])
data_3_B <- as.matrix(data_imp_CSR_0MST33_B_3[match(subset(import_var_B, pctTimesSelected > 50)$var, colnames(data_imp_CSR_0MST33_B_3))])
data_4_B <- as.matrix(data_imp_CSR_0MST33_B_4[match(subset(import_var_B, pctTimesSelected > 50)$var, colnames(data_imp_CSR_0MST33_B_4))])
data_5_B <- as.matrix(data_imp_CSR_0MST33_B_5[match(subset(import_var_B, pctTimesSelected > 50)$var, colnames(data_imp_CSR_0MST33_B_5))])

cor_dist_1_B <- (1 - abs(cor(data_1_B, method = "spearman")))
cor_dist_2_B <- (1 - abs(cor(data_2_B, method = "spearman")))
cor_dist_3_B <- (1 - abs(cor(data_3_B, method = "spearman")))
cor_dist_4_B <- (1 - abs(cor(data_4_B, method = "spearman")))
cor_dist_5_B <- (1 - abs(cor(data_5_B, method = "spearman")))

cor_dist_B_list <- list(cor_dist_1_B,
                        cor_dist_2_B,
                        cor_dist_3_B,
                        cor_dist_4_B,
                        cor_dist_5_B)

cor_mean_dist_B <- apply(simplify2array(cor_dist_B_list), 1:2, mean)

clust_B <- hclust(as.dist(cor_mean_dist_B), method = "complete")

plot(clust_B, main = "Cluster Dendrogram: B Horizons")

rect.hclust(clust_B, k = 4, border = 2:5)

# Verify number of clusters

fviz_nbclust(cor_mean_dist_B,
             FUN = hcut,
             method = "wss",
             k.max = length(colnames(cor_mean_dist_B)) - 1)


# Table 4 - Spearman Correlation Coefficients -----------------------------

# A horizons

data_0_A <- as.matrix(data_imp_CSR_0MST33_A_0[match(subset(import_var_A, pctTimesSelected > 50)$var, colnames(data_imp_CSR_0MST33_A_0))])

spearman_cor_A_0 <- cor(response_CSR_0MST33_A, data_0_A, method = "spearman", use = "pairwise.complete.obs")

spearman_pvalues_A_0 = rep(NA, length(colnames(data_0_A)))

for(i in 1:length(colnames(data_0_A))){
  
  spearman_pvalues_A_0[i] = cor.test(response_CSR_0MST33_A, data_0_A[, i], method = "spearman", exact = TRUE)$p.value

}

spearman_pvalues_A_0 = t(spearman_pvalues_A_0)

colnames(spearman_pvalues_A_0) <- colnames(spearman_cor_A_0)

# B horizons

data_0_B <- as.matrix(data_imp_CSR_0MST33_B_0[match(subset(import_var_B, pctTimesSelected > 50)$var, colnames(data_imp_CSR_0MST33_B_0))])

spearman_cor_B_0 <- cor(response_CSR_0MST33_B, data_0_B, method = "spearman", use = "pairwise.complete.obs")

spearman_pvalues_B_0 = rep(NA, length(colnames(data_0_B)))

for(i in 1:length(colnames(data_0_B))){
  
  spearman_pvalues_B_0[i] = cor.test(response_CSR_0MST33_B, data_0_B[, i], method = "spearman", exact = TRUE)$p.value
  
}

spearman_pvalues_B_0 = t(spearman_pvalues_B_0)

colnames(spearman_pvalues_B_0) <- colnames(spearman_cor_B_0)

# Save Spearman correlation coefficients and p-values to .xlsx files

spearman_A_0 <- data.frame(cbind(colnames(spearman_cor_A_0), t(spearman_cor_A_0), t(spearman_pvalues_A_0)), row.names = NULL)

colnames(spearman_A_0) <- c("Predictor", "Spearmans_rho", "P_value")

write.xlsx(spearman_A_0, "Selected_Predictors_Spearmans_Rho_A_Horizons.xlsx")

spearman_B_0 <- data.frame(cbind(colnames(spearman_cor_B_0), t(spearman_cor_B_0), t(spearman_pvalues_B_0)), row.names = NULL)

colnames(spearman_B_0) <- c("Predictor", "Spearmans_rho", "P_value")

write.xlsx(spearman_B_0, "Selected_Predictors_Spearmans_Rho_B_Horizons.xlsx")

