# File Header -------------------------------------------------------------

# File Name: Fig_3_and_5_Scatter_Plots.R
# Created: April 04, 2021 by Tyler Weiglein
# Last Modified: October 28, 2021 by Tyler Weiglein

# Purpose: To create Figures 3 and 5 (scatter plots of CSR vs. selected 
# predictors for A and B horizons).


# Preliminaries -----------------------------------------------------------

# Clear console and environment

cat("\014") 

rm(list = ls(all.names = TRUE))

# Load package(s)

library(ggplot2)
library(ggpubr)
library(mice)
library(openxlsx)

# Set working directory

setwd("*Insert working directory path here*")

# Load data

load("data_imp_CSR_0MST33_A_mids.RData")
load("data_imp_CSR_0MST33_B_mids.RData")

# Extract non-imputed data

data_A <- complete(data_imp_CSR_0MST33_A_mids, 0)
data_B <- complete(data_imp_CSR_0MST33_B_mids, 0)

# Read in correlation data

corr_data_A <- read.xlsx("Selected_Predictors_Spearmans_Rho_A_Horizons.xlsx")
corr_data_B <- read.xlsx("Selected_Predictors_Spearmans_Rho_B_Horizons.xlsx")


# CSR vs. Selected Predictors Scatter Plots -------------------------------

# Plot preliminaries

site_names <- as.character(data_A$site)

shapes_char <- c("1", "2", "3", "4", "5",
                 "6", "7", "8", "9", "",
                 "1", "2", "3", "4", "5",
                 "1", "2", "3", "4", "5",
                 "1", "2", "3", "4", "5",
                 "1")

shapes_num <- c(21, 22, 23, 24, 25,
                21, 22, 23, 24, 25,
                21, 22, 23, 24, 25,
                21, 22, 23, 24, 25,
                21, 22, 23, 24, 25,
                21)

colors_char <- c("1", "1", "1", "1", "1",
                 "2", "2", "2", "2", "2",
                 "3", "3", "3", "3", "3",
                 "4", "4", "4", "4", "4",
                 "5", "5", "5", "5", "5",
                 "6")

gg_color_hue <- function(n){
  hues = seq(15, 375, length = n + 1)
  hcl(h = hues, l = 65, c = 100)[1:n]
}

ggcol <- gg_color_hue(6)

colors <- c(ggcol[1], ggcol[1], ggcol[1], ggcol[1], ggcol[1],
            ggcol[2], ggcol[2], ggcol[2], ggcol[2], ggcol[2],
            ggcol[3], ggcol[3], ggcol[3], ggcol[3], ggcol[3],
            ggcol[4], ggcol[4], ggcol[4], ggcol[4], ggcol[4],
            ggcol[5], ggcol[5], ggcol[5], ggcol[5], ggcol[5],
            ggcol[6])

# Scatter plot function

scatter_fun = function(x, y, data_hor, xlab, ind, spearman_rho, pval, n, panel_lab, plots_per_row){
  
  if((ind + plots_per_row - 1)%%plots_per_row == 0){
    
    if(pval < 0.001){
      
      ggplot(data = data_hor, aes(x = .data[[x]], y = .data[[y]]/(10^4))) +
        geom_point(aes(shape = site_names, fill = site_names), size = 3) +
        scale_shape_manual(name = "Site", values = shapes_num, labels = site_names) +
        scale_fill_manual(name = "Site", values = colors, labels = site_names) +
        annotate("text", x = max(data_hor[x], na.rm = TRUE)*1.05, y = 0.975*max(data_hor[y], na.rm = TRUE)/(10^4), label = paste0("rho~'='~", deparse(format(round(spearman_rho, 3), nsmall = 3)), "~'(n ='~", n, "*')'"), hjust = 1, vjust = 1, size = 4, parse = TRUE) + #, "~'(n ='~", n,"~')'~" # , format(round(spearman_rho, 3), nsmall = 3)
        annotate("text", x = max(data_hor[x], na.rm = TRUE)*1.05, y = 0.90*max(data_hor[y], na.rm = TRUE)/(10^4), label = paste0("p-value < 0.001"), hjust = 1, vjust = 1, size = 4) +
        labs(tag = panel_lab,
             x = xlab,
             y = "Cumul. Spec. Resp.\n(% SOC Respired)") +
        xlim(NA, max(data_hor[x], na.rm = TRUE)*1.075) +
        theme_bw() +
        theme(panel.grid.major = element_blank(),
              panel.grid.minor = element_blank(),
              axis.title.x = element_text(face = "bold", size = 16, margin = margin(t = 5)),
              axis.title.y = element_text(face = "bold", size = 16, margin = margin(r = 5)),
              axis.text.x = element_text(color = "black", size = 12),
              axis.text.y = element_text(color = "black", size = 12),
              legend.title = element_text(face = "bold", size = 16),
              legend.text = element_text(color = "black", size = 12),
              legend.margin = margin(0, 24, 0, 24),
              aspect.ratio = 1)
      
    }else{
      
      ggplot(data = data_hor, aes(x = .data[[x]], y = .data[[y]]/(10^4))) +
        geom_point(aes(shape = site_names, fill = site_names), size = 3) +
        scale_shape_manual(name = "Site", values = shapes_num, labels = site_names) +
        scale_fill_manual(name = "Site", values = colors, labels = site_names) +
        annotate("text", x = max(data_hor[x], na.rm = TRUE)*1.05, y = 0.975*max(data_hor[y], na.rm = TRUE)/(10^4), label = paste0("rho~'='~", deparse(format(round(spearman_rho, 3), nsmall = 3)), "~'(n ='~", n, "*')'"), hjust = 1, vjust = 1, size = 4, parse = TRUE) + # , "~'(n ='~", n,"~')'~" # , format(round(spearman_rho, 3), nsmall = 3)
        annotate("text", x = max(data_hor[x], na.rm = TRUE)*1.05, y = 0.90*max(data_hor[y], na.rm = TRUE)/(10^4), label = paste0("p-value = ", round(pval, 3)), hjust = 1, vjust = 1, size = 4) +
        labs(tag = panel_lab,
             x = xlab,
             y = "Cumul. Spec. Resp.\n(% SOC Respired)") +
        xlim(NA, max(data_hor[x], na.rm = TRUE)*1.075) +
        theme_bw() +
        theme(panel.grid.major = element_blank(),
              panel.grid.minor = element_blank(),
              axis.title.x = element_text(face = "bold", size = 16, margin = margin(t = 5)),
              axis.title.y = element_text(face = "bold", size = 16, margin = margin(r = 5)),
              axis.text.x = element_text(color = "black", size = 12),
              axis.text.y = element_text(color = "black", size = 12),
              legend.title = element_text(face = "bold", size = 16),
              legend.text = element_text(color = "black", size = 12),
              legend.margin = margin(0, 24, 0, 24),
              aspect.ratio = 1)
      
    }
    
  }else{
    
    if(pval < 0.001){
    
      ggplot(data = data_hor, aes(x = .data[[x]], y = .data[[y]]/(10^4))) +
        geom_point(aes(shape = site_names, fill = site_names), size = 3) +
        scale_shape_manual(name = "Site", values = shapes_num, labels = site_names) +
        scale_fill_manual(name = "Site", values = colors, labels = site_names) +
        annotate("text", x = max(data_hor[x], na.rm = TRUE)*1.05, y = 0.975*max(data_hor[y], na.rm = TRUE)/(10^4), label = paste0("rho~'='~", deparse(format(round(spearman_rho, 3), nsmall = 3)), "~'(n ='~", n, "*')'"), hjust = 1, vjust = 1, size = 4, parse = TRUE) + # , "~'(n ='~", n,"~')'~" # , format(round(spearman_rho, 3), nsmall = 3)
        annotate("text", x = max(data_hor[x], na.rm = TRUE)*1.05, y = 0.90*max(data_hor[y], na.rm = TRUE)/(10^4), label = paste0("p-value < 0.001"), hjust = 1, vjust = 1, size = 4) +
        labs(tag = panel_lab,
             x = xlab,
             y = NULL) +
        xlim(NA, max(data_hor[x], na.rm = TRUE)*1.075) +
        theme_bw() +
        theme(panel.grid.major = element_blank(),
              panel.grid.minor = element_blank(),
              axis.title.x = element_text(face = "bold", size = 16, margin = margin(t = 5)),
              axis.title.y = element_text(face = "bold", size = 16, margin = margin(r = 5)),
              axis.text.x = element_text(color = "black", size = 12),
              axis.text.y = element_text(color = "black", size = 12),
              legend.title = element_text(face = "bold", size = 16),
              legend.text = element_text(color = "black", size = 12),
              legend.margin = margin(0, 24, 0, 24),
              aspect.ratio = 1)
    
    }else{
    
      ggplot(data = data_hor, aes(x = .data[[x]], y = .data[[y]]/(10^4))) +
        geom_point(aes(shape = site_names, fill = site_names), size = 3) +
        scale_shape_manual(name = "Site", values = shapes_num, labels = site_names) +
        scale_fill_manual(name = "Site", values = colors, labels = site_names) +
        annotate("text", x = max(data_hor[x], na.rm = TRUE)*1.05, y = 0.975*max(data_hor[y], na.rm = TRUE)/(10^4), label = paste0("rho~'='~", deparse(format(round(spearman_rho, 3), nsmall = 3)), "~'(n ='~", n, "*')'"), hjust = 1, vjust = 1, size = 4, parse = TRUE) + # , "~'(n ='~", n,"~')'~" # , 
        annotate("text", x = max(data_hor[x], na.rm = TRUE)*1.05, y = 0.90*max(data_hor[y], na.rm = TRUE)/(10^4), label = paste0("p-value = ", round(pval, 3)), hjust = 1, vjust = 1, size = 4) +
        labs(tag = panel_lab,
             x = xlab,
             y = NULL) +
        xlim(NA, max(data_hor[x], na.rm = TRUE)*1.075) +
        theme_bw() +
        theme(panel.grid.major = element_blank(),
              panel.grid.minor = element_blank(),
              axis.title.x = element_text(face = "bold", size = 16, margin = margin(t = 5)),
              axis.title.y = element_text(face = "bold", size = 16, margin = margin(r = 5)),
              axis.text.x = element_text(color = "black", size = 12),
              axis.text.y = element_text(color = "black", size = 12),
              legend.title = element_text(face = "bold", size = 16),
              legend.text = element_text(color = "black", size = 12),
              legend.margin = margin(0, 24, 0, 24),
              aspect.ratio = 1)
      
    }
      
  }
  
}

# A horizons

# Selected predictor column names

sel_pred_A <- c("BTC_LIG_BULK",
                "BTC_LIG_HF",
                "Sd_Sl_BULK","SP_Fe.g100g_BULK",
                "AO_Fe.g100g_BULK",
                "AO_Al.g100g_BULK",
                "DC_Al.g100g_BULK",
                "MAP_Eref",
                "AHM",
                "SHM",
                "CMD",
                "Al_KCl.ugg_BULK")

xlabs_A <- c("BTCA:Lignin Ratio\n(Bulk Soil)",
             "BTCA:Lignin Ratio\n(Heavy Fraction)",
             "Syringyl Phenols\nAcid:Aldehyde Ratio",
             "Sodium Pyrophosphate\nExtractable Fe (g/100 g)",
             "Ammonium Oxalate\nExtractable Fe (g/100 g)",
             "Ammonium Oxalate\nExtractable Al (g/100 g)",
             "Dithionite-Citrate\nExtractable Al (g/100 g)",
             "MAP - Hargreaves\nRef. Evap. (mm)",
             "Annual Heat:Moisture\nIndex",
             "Summer Heat:Moisture\nIndex",
             "Hargreaves Climatic\nMoisture Deficit (mm)",
             "Potassium Chloride\nExtractable Al (mg/kg)")

panel_labs_A <- c("(a)",
                  "(b)",
                  "(c)",
                  "(d)",
                  "(e)",
                  "(f)",
                  "(g)",
                  "(h)",
                  "(i)",
                  "(j)",
                  "(k)",
                  "(l)")

# Match correlation coefficients and p-values w/ predictors

corr_A <- corr_data_A[match(sel_pred_A, corr_data_A$Predictor), ]

# Create CSR vs. predictor plots

for(i in 1:length(sel_pred_A)){
  
  n_sites <- nrow(data_A[sel_pred_A[i]]) - sum(is.na(data_A[sel_pred_A[i]]))
  
  assign(paste0("plot_", i), scatter_fun(x = sel_pred_A[i], y = "t52_cumul_spec_resp_ugC_per_gC", data_hor = data_A, xlab = xlabs_A[i], ind = i, spearman_rho = corr_A$Spearmans_rho[i], pval = corr_A$P_value[i], n = n_sites, panel_lab = panel_labs_A[i], plots_per_row = 4))
  
}

ggarrange(plot_1,
          plot_2,
          plot_3,
          plot_4,
          plot_5,
          plot_6,
          plot_7,
          plot_8,
          plot_9,
          plot_10,
          plot_11,
          plot_12,
          ncol = 4,
          nrow = 3,
          align = "hv",
          common.legend = TRUE,
          legend = "right")

# B horizons

# Selected predictor column names

sel_pred_B <- c("BTC_LIG_BULK",
                "CN.mol_BULK",
                "CN.mol_HF",
                "MeanDBE_C_BULK",
                "fresh_HWE_BULK",
                "MAP_Eref",
                "AHM")

xlabs_B <- c("BTCA:Lignin Ratio\n",
             "C:N Ratio\n(Bulk Soil)",
             "C:N Ratio\n(Heavy Fraction)",
             "Chloroform Extract\nMean DBE",
             "Hot Water Extract\nBiological Index",
             "MAP - Hargreaves\nRef. Evap. (mm)",
             "Annual Heat:Moisture Index\n")

panel_labs_B <- c("(a)",
                  "(b)",
                  "(c)",
                  "(d)",
                  "(e)",
                  "(f)",
                  "(g)")

# Match correlation coefficients and p-values w/ predictors

corr_B <- corr_data_B[match(sel_pred_B, corr_data_B$Predictor), ]

# Create CSR vs. predictor plots

for(i in 1:length(sel_pred_B)){
  
  n_sites <- nrow(data_B[sel_pred_B[i]]) - sum(is.na(data_B[sel_pred_B[i]]))
  
  assign(paste0("plot_", i), scatter_fun(x = sel_pred_B[i], y = "t52_cumul_spec_resp_ugC_per_gC", data_hor = data_B, xlab = xlabs_B[i], ind = i, spearman_rho = corr_B$Spearmans_rho[i], pval = corr_B$P_value[i], n = n_sites, panel_lab = panel_labs_B[i], plots_per_row = 3))
  
}

ggarrange(plot_1,
          plot_2,
          plot_3,
          plot_4,
          plot_5,
          plot_6,
          plot_7,
          ncol = 3,
          nrow = 3,
          align = "hv",
          common.legend = TRUE,
          legend = "right")
