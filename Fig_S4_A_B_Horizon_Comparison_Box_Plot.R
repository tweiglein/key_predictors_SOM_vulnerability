# File Header -------------------------------------------------------------

# File Name: Fig_S4_A_B_Horizon_Comparison_Box_Plot.R
# Created: July 29, 2020 by Tyler Weiglein
# Last Modified: October 28, 2021 by Tyler Weiglein

# Purpose: To create Figure S4 (box plot comparing predictors that significantly
# differ between A and B horizons) for Supplementary Information section.


# Preliminaries -----------------------------------------------------------

# Clear console and environment

cat("\014") 

rm(list = ls(all.names = TRUE))

# Load package(s)

library(car)
library(ggplot2)
library(ggpubr)
library(gridExtra)
library(lawstat)
library(mice)

# Set working directory

setwd("*Insert working directory path here*")

# Load data

data_full <- read.csv("data.csv")

load("data_imp_CSR_0MST33_A_mids.RData")
load("data_imp_CSR_0MST33_B_mids.RData")

# Extract non-imputed data

data_A <- complete(data_imp_CSR_0MST33_A_mids, 0)
data_B <- complete(data_imp_CSR_0MST33_B_mids, 0)

# Combine data

data <- rbind(data_A, data_B)

data <- cbind(data, data_full$OC.g100g_BULK[match(paste(data$site, data$horizon_type), paste(data_full$site, data_full$horizon_type))])

colnames(data)[length(data)] <- "OC.g100g_BULK"

# Predictors to test

pred_names <- c("midpoint_depth.cm_BULK",
                "WS_bulk_density.gcm3_BULK",
                "proportion_fine.gg_BULK",
                "mass_fine.Mgha_BULK",
                "mass_coarse.Mgha_BULK",
                "sand.gg_BULK",
                "silt.gg_BULK",
                "clay.gg_BULK",
                "pssa.m2g_BULK",
                "pH_BULK",
                "magsus_corrected.chi_BULK",
                "Ca_NH4Act.ugg_BULK",
                "K_NH4Act.ugg_BULK",
                "Mg_NH4Act.ugg_BULK",
                "Na_NH4Act.ugg_BULK",
                "Al_KCl.ugg_BULK",
                "Fe_KCl.ugg_BULK",
                "DC_Al.g100g_BULK",
                "DC_Fe.g100g_BULK",
                "DC_Mn.g100g_BULK",
                "DC_Si.g100g_BULK",
                "SP_Al.g100g_BULK",
                "SP_Fe.g100g_BULK",
                "SP_Mn.g100g_BULK",
                "SP_Si.g100g_BULK",
                "AO_Al.g100g_BULK",
                "AO_Fe.g100g_BULK",
                "AO_Mn.mgkg_BULK",
                "AO_Si.g100g_BULK",
                "OC.g100g_BULK",
                "CN.mol_BULK",
                "BPCA_tot.mggOC_BULK",
                "BPCA_b6_tot.ratio_BULK",
                "V.uggOC_BULK",
                "S.uggOC_BULK",
                "C.uggOC_BULK",
                "LIG.uggOC_BULK",
                "P.uggOC_BULK",
                "MON.uggOC_BULK",
                "BA.uggOC_BULK",
                "BDC.uggOC_BULK",
                "BTC.uggOC_BULK",
                "S_V_BULK",
                "C_V_BULK",
                "Vd_Vl_BULK",
                "Sd_Sl_BULK",
                "X3.5.Bd_LIG_BULK",
                "P_LIG_BULK",
                "FA_LIG_BULK",
                "DA_LIG_BULK",
                "BTC_LIG_BULK",
                "FI_CWE_BULK",
                "FI_HWE_BULK",
                "max_em_370_CWE_BULK",
                "max_em_370_HWE_BULK",
                "abs_254_CWE_BULK",
                "abs_254_HWE_BULK",
                "HIX_CWE_BULK",
                "HIX_HWE_BULK",
                "fresh_CWE_BULK",
                "fresh_HWE_BULK",
                "MeanDBE_AI_C_BULK",
                "MeanDBE_AI_M_BULK",
                "MeanDBE_AI_W_BULK",
                "MeanDBE_C_BULK",
                "MeanDBE_M_BULK",
                "MeanDBE_W_BULK",
                "MeanDBE_O_C_BULK",
                "MeanDBE_O_M_BULK",
                "MeanDBE_O_W_BULK",
                "MeanGFE_C_BULK",
                "MeanGFE_M_BULK",
                "MeanGFE_W_BULK",
                "MeanHtoC_C_BULK",
                "MeanHtoC_M_BULK",
                "MeanHtoC_W_BULK",
                "MeanKdefect_C_BULK",
                "MeanKdefect_M_BULK",
                "MeanKdefect_W_BULK",
                "MeanKmass_C_BULK",
                "MeanKmass_M_BULK",
                "MeanKmass_W_BULK",
                "MeanOtoC_C_BULK",
                "MeanOtoC_M_BULK",
                "MeanOtoC_W_BULK",
                "prop_C_FLF",
                "prop_C_OCC",
                "prop_C_HF")

# Initialize statistical comparison vector vector

norm <- rep(NA, length(pred_names))

eq_var <- rep(NA, length(pred_names))

p_val <- rep(NA, length(pred_names))

# Create data frame for statistical comparisons

test_df <- as.data.frame(cbind(pred_names, norm, eq_var, p_val), stringsAsFactors = FALSE)

test_df$p_val <- as.numeric(test_df$p_val)

# Statistical comparisons between A and B horizons

for(i in 1:length(pred_names)){
  
  # Test for normality
  
  norm_test_A <- shapiro.test(as.numeric(unlist(subset(data, horizon_type == "A-Horizon")[pred_names[i]])))
  norm_test_B <- shapiro.test(as.numeric(unlist(subset(data, horizon_type == "Upper B-Horizon")[pred_names[i]])))
  
  if(norm_test_A$p.value > 0.05 & norm_test_B$p.value > 0.05){  # Normality assumption met
    
    # Test for equal variances
    
    if(leveneTest(as.numeric(unlist(data[pred_names[i]])), data$horizon_type)$'Pr(>F)'[1] > 0.05){  # Equal variances assumption met
      
      test <- t.test(as.numeric(unlist(subset(data, horizon_type == "A-Horizon")[pred_names[i]])), as.numeric(unlist(subset(data, horizon_type == "Upper B-Horizon")[pred_names[i]])), paired = TRUE, var.equal = TRUE)
      
      test_df$norm[i] <- "TRUE"
      
      test_df$eq_var[i] <- "TRUE"
      
      test_df$p_val[i] <- test$p.value
      
    }else{  # Equal variances assumption NOT met
      
      test <- t.test(as.numeric(unlist(subset(data, horizon_type == "A-Horizon")[pred_names[i]])), as.numeric(unlist(subset(data, horizon_type == "Upper B-Horizon")[pred_names[i]])), paired = TRUE, var.equal = FALSE)
      
      test_df$norm[i] <- "TRUE"
      
      test_df$eq_var[i] <- "FALSE"
      
      test_df$p_val[i] <- test$p.value
      
    }
    
  }else{  # Normality assumption NOT met
    
    # Test for equal variances
    
    if(leveneTest(as.numeric(unlist(data[pred_names[i]])), data$horizon_type)$'Pr(>F)'[1] > 0.05){  # Equal variances assumption met
      
      test <- wilcox.test(as.numeric(unlist(subset(data, horizon_type == "A-Horizon")[pred_names[i]])), as.numeric(unlist(subset(data, horizon_type == "Upper B-Horizon")[pred_names[i]])), paired = TRUE)
      
      test_df$norm[i] <- "FALSE"
      
      test_df$eq_var[i] <- "TRUE"
      
      test_df$p_val[i] <- test$p.value
      
    }else{  # Equal variances assumption NOT met
      
      test <- brunner.munzel.test(as.numeric(unlist(subset(data, horizon_type == "A-Horizon")[pred_names[i]])), as.numeric(unlist(subset(data, horizon_type == "Upper B-Horizon")[pred_names[i]])))
      
      test_df$norm[i] <- "FALSE"
      
      test_df$eq_var[i] <- "FALSE"
      
      test_df$p_val[i] <- test$p.value
      
    }    
    
  }
  
}

# Specify selected predictors (after applying Bonferroni correction)

sel_pred <- subset(test_df, p_val < (0.05/length(pred_names)))


# Box Plot ----------------------------------------------------------------

sel_pred_names <- factor(c(rep("Composite horizon\nmidpoint depth", length(data$midpoint_depth.cm_BULK)),
                           rep("Bulk density", length(data$WS_bulk_density.gcm3_BULK)),
                           rep("Dithionite-citrate\nextractable Fe", length(data$DC_Fe.g100g_BULK)),
                           rep("Sodium pyrophosphate\nextractable Mn", length(data$SP_Mn.g100g_BULK)),
                           rep("Percent organic C", length(data$OC.g100g_BULK)),
                           rep("Benzene hexacarboxylic\nacid:Total BPCA ratio", length(data$BPCA_b6_tot.ratio_BULK)),
                           rep("Syringyl phenols\nacid:aldehyde ratio", length(data$Sd_Sl_BULK)),
                           rep("3,5-di-hydroxy benzoic\nacid:lignin ratio", length(data$X3.5.Bd_LIG_BULK)),
                           rep("Fatty acids:lignin ratio", length(data$FA_LIG_BULK)),
                           rep("Di-acids:lignin ratio", length(data$DA_LIG_BULK)),
                           rep("Proportion of C in\nfree light fraction", length(data$prop_C_FLF))),
                         levels = c("Composite horizon\nmidpoint depth",
                                    "Bulk density",
                                    "Dithionite-citrate\nextractable Fe",
                                    "Sodium pyrophosphate\nextractable Mn",
                                    "Percent organic C",
                                    "Benzene hexacarboxylic\nacid:Total BPCA ratio",
                                    "Syringyl phenols\nacid:aldehyde ratio",
                                    "3,5-di-hydroxy benzoic\nacid:lignin ratio",
                                    "Fatty acids:lignin ratio",
                                    "Di-acids:lignin ratio",
                                    "Proportion of C in\nfree light fraction"),
                         ordered = TRUE)

horizon_type <- factor(rep(data$horizon_type, length(unique(sel_pred_names))))

sel_pred_scaled_val <- c(scale(data$midpoint_depth.cm_BULK),
                         scale(data$WS_bulk_density.gcm3_BULK),
                         scale(data$DC_Fe.g100g_BULK),
                         scale(data$SP_Mn.g100g_BULK),
                         scale(data$OC.g100g_BULK),
                         scale(data$BPCA_b6_tot.ratio_BULK),
                         scale(data$Sd_Sl_BULK),
                         scale(data$X3.5.Bd_LIG_BULK),
                         scale(data$FA_LIG_BULK),
                         scale(data$DA_LIG_BULK),
                         scale(data$prop_C_FLF))

sel_pred_box_plot_df <- data.frame(sel_pred_names, horizon_type, sel_pred_scaled_val)

sel_pred_box_plot <- ggplot(data = sel_pred_box_plot_df,
                            mapping = aes(x = sel_pred_names, y = sel_pred_scaled_val, fill = horizon_type))

# Create box plot

plot <- sel_pred_box_plot + 
  stat_boxplot(geom = "errorbar") +
  geom_boxplot() +
  xlab("Predictor") +
  ylab("Scaled Value") +
  ylim(c(-3.75, 6.9)) +
  annotate("text", x = seq(1:length(sel_pred$p_val)), y = rep(5, length(sel_pred$p_val)), label = paste("P = ", formatC(sel_pred$p_val, format = "e", digits = 2), sep = ""), size = 5.5) +
  scale_fill_discrete(name = "Horizon Type", labels = c("A Horizon", "B Horizon")) +
  theme_bw() +
  theme(panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.title.x = element_text(face = "bold", size = 24, margin = margin(t = 25)),
        axis.title.y = element_text(face = "bold", size = 24, margin = margin(r = 15)),
        axis.text.x = element_text(color = "black", size = 18, angle = 90, vjust = 0.5, hjust = 1),
        axis.text.y = element_text(color = "black", size = 18),
        legend.title = element_text(face = "bold", size = 24),
        legend.text = element_text(size = 18))
