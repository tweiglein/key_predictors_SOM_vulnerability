# File Header -------------------------------------------------------------

# File Name: Fig_6_Cluster_Dendrogram_B_Horizons.R
# Created: January 17, 2020 by Tyler Weiglein
# Last Modified: October 28, 2021 by Tyler Weiglein

# Purpose: To generate Figure 6 (cluster dendrogram for B horizons). The
# cluster dendrogram shows the relative correlation (using Spearman's 
# correlation coefficient) among the predictors selected by the Boruta
# algorithm. These predictors are then grouped based on the "Elbow method."


# Preliminaries -----------------------------------------------------------

# Clear console and environment

cat("\014") 

rm(list = ls(all.names = TRUE))

# Load package(s)

library(Boruta)
library(factoextra)
library(ggplot2)
library(ggdendro)
library(mice)

# Set working directory

setwd("*Insert working directory path here*")

# Specify selection threshold

selection_threshold = 0.5


# Specify Imputed Predictor Data Sets -------------------------------------

# Read in mids objects corresponding to imputed predictor data sets

load("data_imp_CSR_0MST33_B_mids.RData")

# Create separate imputed data sets

for(i in 0:data_imp_CSR_0MST33_B_mids$m){

  data_set_name <- paste("data_imp_CSR_0MST33_B_", i, sep = "")
  assign(data_set_name, complete(data_imp_CSR_0MST33_B_mids, i))

}


# Separate Response from Predictors ---------------------------------------

# Response vectors

response_CSR_0MST33_B <- data_imp_CSR_0MST33_B_1$t52_cumul_spec_resp_ugC_per_gC

# Predictors data frames

predictors_B_1 <- data_imp_CSR_0MST33_B_1[, -(match("site", colnames(data_imp_CSR_0MST33_B_1)):match("t52_cumul_spec_resp_ugC_per_gC", colnames(data_imp_CSR_0MST33_B_1)))]
predictors_B_2 <- data_imp_CSR_0MST33_B_2[, -(match("site", colnames(data_imp_CSR_0MST33_B_2)):match("t52_cumul_spec_resp_ugC_per_gC", colnames(data_imp_CSR_0MST33_B_2)))]
predictors_B_3 <- data_imp_CSR_0MST33_B_3[, -(match("site", colnames(data_imp_CSR_0MST33_B_3)):match("t52_cumul_spec_resp_ugC_per_gC", colnames(data_imp_CSR_0MST33_B_3)))]
predictors_B_4 <- data_imp_CSR_0MST33_B_4[, -(match("site", colnames(data_imp_CSR_0MST33_B_4)):match("t52_cumul_spec_resp_ugC_per_gC", colnames(data_imp_CSR_0MST33_B_4)))]
predictors_B_5 <- data_imp_CSR_0MST33_B_5[, -(match("site", colnames(data_imp_CSR_0MST33_B_5)):match("t52_cumul_spec_resp_ugC_per_gC", colnames(data_imp_CSR_0MST33_B_5)))]


# Feature Selection w/ Boruta Algorithm -----------------------------------

# Specify key variables

seed = 1
max_num_runs = 1000

# Boruta algorithm using imputed data set 1

set.seed(seed)

Boruta_B_imp_1 <- Boruta(predictors_B_1,
                         response_CSR_0MST33_B,
                         maxRuns = max_num_runs)

# Boruta algorithm using imputed data set 2

set.seed(seed)

Boruta_B_imp_2 <- Boruta(predictors_B_2,
                         response_CSR_0MST33_B,
                         maxRuns = max_num_runs)

# Boruta algorithm using imputed data set 3

set.seed(seed)

Boruta_B_imp_3 <- Boruta(predictors_B_3,
                         response_CSR_0MST33_B,
                         maxRuns = max_num_runs)

# Boruta algorithm using imputed data set 4

set.seed(seed)

Boruta_B_imp_4 <- Boruta(predictors_B_4,
                         response_CSR_0MST33_B,
                         maxRuns = max_num_runs)

# Boruta algorithm using imputed data set 5

set.seed(seed)

Boruta_B_imp_5 <- Boruta(predictors_B_5,
                         response_CSR_0MST33_B,
                         maxRuns = max_num_runs)

# Get summary of Boruta algorithm output

importRank = seq(from = 1,
                 to = length(attStats(Boruta_B_imp_1)$meanImp),
                 by = 1)

summary_Boruta_B_imp_1 <- cbind(attStats(Boruta_B_imp_1)[order(attStats(Boruta_B_imp_1)$meanImp, decreasing = TRUE), ], importRank)
summary_Boruta_B_imp_2 <- cbind(attStats(Boruta_B_imp_2)[order(attStats(Boruta_B_imp_2)$meanImp, decreasing = TRUE), ], importRank)
summary_Boruta_B_imp_3 <- cbind(attStats(Boruta_B_imp_3)[order(attStats(Boruta_B_imp_3)$meanImp, decreasing = TRUE), ], importRank)
summary_Boruta_B_imp_4 <- cbind(attStats(Boruta_B_imp_4)[order(attStats(Boruta_B_imp_4)$meanImp, decreasing = TRUE), ], importRank)
summary_Boruta_B_imp_5 <- cbind(attStats(Boruta_B_imp_5)[order(attStats(Boruta_B_imp_5)$meanImp, decreasing = TRUE), ], importRank)

# Combine summary data: B horizons

var <- rownames(summary_Boruta_B_imp_1)

pctTimesSelected <- rep(NA, length(var))
meanImpMean <- rep(NA, length(var))
meanImportRank <- rep(NA, length(var))
pctImputed <- rep(NA, length(var))

for(i in 1:length(var)){
  
  i_1 <- match(var[i], rownames(summary_Boruta_B_imp_1))
  i_2 <- match(var[i], rownames(summary_Boruta_B_imp_2))
  i_3 <- match(var[i], rownames(summary_Boruta_B_imp_3))
  i_4 <- match(var[i], rownames(summary_Boruta_B_imp_4))
  i_5 <- match(var[i], rownames(summary_Boruta_B_imp_5))
  
  pctTimesSelected[i] <- sum(summary_Boruta_B_imp_1$decision[i_1] == "Confirmed",
                             summary_Boruta_B_imp_2$decision[i_2] == "Confirmed",
                             summary_Boruta_B_imp_3$decision[i_3] == "Confirmed",
                             summary_Boruta_B_imp_4$decision[i_4] == "Confirmed",
                             summary_Boruta_B_imp_5$decision[i_5] == "Confirmed")/5*100
  
  meanImpMean[i] <- sum(summary_Boruta_B_imp_1$meanImp[i_1],
                        summary_Boruta_B_imp_2$meanImp[i_2],
                        summary_Boruta_B_imp_3$meanImp[i_3],
                        summary_Boruta_B_imp_4$meanImp[i_4],
                        summary_Boruta_B_imp_5$meanImp[i_5])/5
  
  meanImportRank[i] <- sum(summary_Boruta_B_imp_1$importRank[i_1],
                           summary_Boruta_B_imp_2$importRank[i_2],
                           summary_Boruta_B_imp_3$importRank[i_3],
                           summary_Boruta_B_imp_4$importRank[i_4],
                           summary_Boruta_B_imp_5$importRank[i_5])/5
  
  pctImputed[i] = sum(is.na(data_imp_CSR_0MST33_B_0[[var[i]]]))/length(data_imp_CSR_0MST33_B_0[[var[i]]])*100
  
}

all_var_B <- data.frame(var,
                        pctTimesSelected,
                        meanImpMean,
                        meanImportRank,
                        pctImputed)

import_var_B <- subset(all_var_B, pctTimesSelected > 0)[order(subset(all_var_B, pctTimesSelected > 0)$meanImportRank), ]


# Correlation Cluster Dendrogram ------------------------------------------

# Create dendrograms for B horzion variables

data_1_B <- as.matrix(data_imp_CSR_0MST33_B_1[match(subset(import_var_B, pctTimesSelected > 50)$var, colnames(data_imp_CSR_0MST33_B_1))])
data_2_B <- as.matrix(data_imp_CSR_0MST33_B_2[match(subset(import_var_B, pctTimesSelected > 50)$var, colnames(data_imp_CSR_0MST33_B_2))])
data_3_B <- as.matrix(data_imp_CSR_0MST33_B_3[match(subset(import_var_B, pctTimesSelected > 50)$var, colnames(data_imp_CSR_0MST33_B_3))])
data_4_B <- as.matrix(data_imp_CSR_0MST33_B_4[match(subset(import_var_B, pctTimesSelected > 50)$var, colnames(data_imp_CSR_0MST33_B_4))])
data_5_B <- as.matrix(data_imp_CSR_0MST33_B_5[match(subset(import_var_B, pctTimesSelected > 50)$var, colnames(data_imp_CSR_0MST33_B_5))])

cor_dist_1_B <- (1 - abs(cor(data_1_B, method = "spearman")))
cor_dist_2_B <- (1 - abs(cor(data_2_B, method = "spearman")))
cor_dist_3_B <- (1 - abs(cor(data_3_B, method = "spearman")))
cor_dist_4_B <- (1 - abs(cor(data_4_B, method = "spearman")))
cor_dist_5_B <- (1 - abs(cor(data_5_B, method = "spearman")))

cor_dist_B_list <- list(cor_dist_1_B,
                        cor_dist_2_B,
                        cor_dist_3_B,
                        cor_dist_4_B,
                        cor_dist_5_B)

cor_mean_dist_B <- apply(simplify2array(cor_dist_B_list), 1:2, mean)

rownames(cor_mean_dist_B) <- c("Hot water extract\nbiological index",
                               "Annual heat:moisture index",
                               "MAP - Hargreaves\nreference evaporation",
                               "Chloroform extract\nmean DBE",
                               "C:N ratio\n(bulk soil)",
                               "BTCA:lignin ratio",
                               "C:N ratio\n(heavy fraction)")

colnames(cor_mean_dist_B) <- c("Hot water extract\nbiological index",
                               "Annual heat:moisture index",
                               "MAP - Hargreaves\nreference evaporation",
                               "Chloroform extract\nmean DBE",
                               "C:N ratio\n(bulk soil)",
                               "BTCA:lignin ratio",
                               "C:N ratio\n(heavy fraction)")

clust_B <- hclust(as.dist(cor_mean_dist_B), method = "complete")

ggdendrogram(clust_B, theme_dendro = FALSE) +
  scale_y_continuous(limits = c(0, 1), breaks = c(0, 0.5, 1)) +
  xlab("Predictors Selected by Boruta Algorithm") +
  ylab("Spearman Correlation Distance") +
  theme(panel.background = element_blank(),
        panel.border = element_blank(),
        panel.grid.major = element_blank(),
        axis.ticks.x = element_blank(),
        axis.title = element_text(face = "bold", size = 16),
        axis.title.x = element_text(margin = margin(t = 25)),
        axis.title.y = element_text(margin = margin(r = 10)),
        axis.text.x = element_text(vjust = 0.5, hjust = 1, margin = margin(t = -10), size = 14),
        axis.text.y = element_text(angle = 0, hjust = 0.5, size = 14))

# Verify number of clusters

fviz_nbclust(cor_mean_dist_B,
             FUN = hcut,
             method = "wss",
             k.max = length(colnames(cor_mean_dist_B)) - 1)

