# File Header -------------------------------------------------------------

# File Name: Data_Imputation.R
# Created: October 31, 2019 by Tyler Weiglein
# Last Modified: April 09, 2021 by Tyler Weiglein

# Purpose: To impute missing data using Multivariate Imputation by Chained 
# Equations (MICE) with random forest method and save output to file(s).

# Data analysis code should be run in the following order:
# 1) Data_Imputation.R
# 2) Boruta_Cluster_CSR_t_0_52_wks.R


# Preliminaries -----------------------------------------------------------

# Clear console and environment

cat("\014") 

rm(list = ls(all.names = TRUE))

# Load package(s)

library(mice)

# Set working directory

setwd("*Insert working directory path here*")

# Read in data

data <- read.csv("data.csv")

# Set character variables as factors

data$site <- as.factor(data$site)
data$horizon_type <- as.factor(data$horizon_type)


# Impute Predictor Variables ----------------------------------------------

# Identify column indices

col_i <- c(match("site", colnames(data)), 
           match("horizon_type", colnames(data)), 
           match("Incubation.Ambient.MST.class", colnames(data)):match("N.g100g_HF", colnames(data)))

# Separate predictors

predictors_pre_imp <- data[, col_i]

options(max.print = 1E5)

summary(predictors_pre_imp)

save(predictors_pre_imp, file = "predictors_pre_imp.RData")

# Impute data with Multivariate Imputation by Chained Equations (MICE) using random forest method

predictors_imp <- mice(predictors_pre_imp,
                       method = "rf",
                       visitSequence = "monotone",
                       seed = 1,
                       maxit = 20)

plot(predictors_imp)

save(predictors_imp, file = "predictors_imp.RData")


# Process and Save Imputed Data -------------------------------------------

# Short cut to avoid time-consuming imputation: 
# load("predictors_imp.RData")
# load("predictors_pre_imp.RData")

# Stack imputed data sets to calculate prop_C_FLF, prop_C_OCC, prop_C_HF, prop_N_FLF, prop_N_OCC, and prop_N_HF

predictors_imp_stacked <- complete(predictors_imp, action = "long")

# Calculate prop_C_FLF, prop_C_OCC, prop_C_HF, prop_N_FLF, prop_N_OCC, and prop_N_HF

prop_C_FLF <- predictors_imp_stacked$FLF.g100g_BULK*predictors_imp_stacked$OC.g100g_FLF/(predictors_imp_stacked$FLF.g100g_BULK*predictors_imp_stacked$OC.g100g_FLF + predictors_imp_stacked$OCC.g100g_BULK*predictors_imp_stacked$OC.g100g_OCC + predictors_imp_stacked$HF.g100g_BULK*predictors_imp_stacked$OC.g100g_HF)
prop_C_OCC <- predictors_imp_stacked$OCC.g100g_BULK*predictors_imp_stacked$OC.g100g_OCC/(predictors_imp_stacked$FLF.g100g_BULK*predictors_imp_stacked$OC.g100g_FLF + predictors_imp_stacked$OCC.g100g_BULK*predictors_imp_stacked$OC.g100g_OCC + predictors_imp_stacked$HF.g100g_BULK*predictors_imp_stacked$OC.g100g_HF)
prop_C_HF <- predictors_imp_stacked$HF.g100g_BULK*predictors_imp_stacked$OC.g100g_HF/(predictors_imp_stacked$FLF.g100g_BULK*predictors_imp_stacked$OC.g100g_FLF + predictors_imp_stacked$OCC.g100g_BULK*predictors_imp_stacked$OC.g100g_OCC + predictors_imp_stacked$HF.g100g_BULK*predictors_imp_stacked$OC.g100g_HF)

prop_N_FLF <- predictors_imp_stacked$FLF.g100g_BULK*predictors_imp_stacked$N.g100g_FLF/(predictors_imp_stacked$FLF.g100g_BULK*predictors_imp_stacked$N.g100g_FLF + predictors_imp_stacked$OCC.g100g_BULK*predictors_imp_stacked$N.g100g_OCC + predictors_imp_stacked$HF.g100g_BULK*predictors_imp_stacked$N.g100g_HF)
prop_N_OCC <- predictors_imp_stacked$OCC.g100g_BULK*predictors_imp_stacked$N.g100g_OCC/(predictors_imp_stacked$FLF.g100g_BULK*predictors_imp_stacked$N.g100g_FLF + predictors_imp_stacked$OCC.g100g_BULK*predictors_imp_stacked$N.g100g_OCC + predictors_imp_stacked$HF.g100g_BULK*predictors_imp_stacked$N.g100g_HF)
prop_N_HF <- predictors_imp_stacked$HF.g100g_BULK*predictors_imp_stacked$N.g100g_HF/(predictors_imp_stacked$FLF.g100g_BULK*predictors_imp_stacked$N.g100g_FLF + predictors_imp_stacked$OCC.g100g_BULK*predictors_imp_stacked$N.g100g_OCC + predictors_imp_stacked$HF.g100g_BULK*predictors_imp_stacked$N.g100g_HF)

# Indicate variables to remove

variables_remove <- c("FLF.g100g_BULK",
                      "OCC.g100g_BULK",
                      "HF.g100g_BULK",
                      "OC.g100g_FLF",
                      "OC.g100g_OCC",
                      "OC.g100g_HF",
                      "N.g100g_FLF",
                      "N.g100g_OCC",
                      "N.g100g_HF")

# Remove variables

predictors_imp_stacked <- predictors_imp_stacked[, -match(variables_remove, colnames(predictors_imp_stacked))]

# Combine predictors with proportion C and N in density fractions data

predictors_imp_stacked <- cbind(predictors_imp_stacked,
                                prop_C_FLF,
                                prop_C_OCC,
                                prop_C_HF,
                                prop_N_FLF,
                                prop_N_OCC,
                                prop_N_HF)
                                
# ORIGINAL DATA: Calculate prop_C_FLF, prop_C_OCC, prop_C_HF, prop_N_FLF, prop_N_OCC, prop_N_HF, and base_cations.umolcg_BULK

prop_C_FLF <- predictors_pre_imp$FLF.g100g_BULK*predictors_pre_imp$OC.g100g_FLF/(predictors_pre_imp$FLF.g100g_BULK*predictors_pre_imp$OC.g100g_FLF + predictors_pre_imp$OCC.g100g_BULK*predictors_pre_imp$OC.g100g_OCC + predictors_pre_imp$HF.g100g_BULK*predictors_pre_imp$OC.g100g_HF)
prop_C_OCC <- predictors_pre_imp$OCC.g100g_BULK*predictors_pre_imp$OC.g100g_OCC/(predictors_pre_imp$FLF.g100g_BULK*predictors_pre_imp$OC.g100g_FLF + predictors_pre_imp$OCC.g100g_BULK*predictors_pre_imp$OC.g100g_OCC + predictors_pre_imp$HF.g100g_BULK*predictors_pre_imp$OC.g100g_HF)
prop_C_HF <- predictors_pre_imp$HF.g100g_BULK*predictors_pre_imp$OC.g100g_HF/(predictors_pre_imp$FLF.g100g_BULK*predictors_pre_imp$OC.g100g_FLF + predictors_pre_imp$OCC.g100g_BULK*predictors_pre_imp$OC.g100g_OCC + predictors_pre_imp$HF.g100g_BULK*predictors_pre_imp$OC.g100g_HF)

prop_N_FLF <- predictors_pre_imp$FLF.g100g_BULK*predictors_pre_imp$N.g100g_FLF/(predictors_pre_imp$FLF.g100g_BULK*predictors_pre_imp$N.g100g_FLF + predictors_pre_imp$OCC.g100g_BULK*predictors_pre_imp$N.g100g_OCC + predictors_pre_imp$HF.g100g_BULK*predictors_pre_imp$N.g100g_HF)
prop_N_OCC <- predictors_pre_imp$OCC.g100g_BULK*predictors_pre_imp$N.g100g_OCC/(predictors_pre_imp$FLF.g100g_BULK*predictors_pre_imp$N.g100g_FLF + predictors_pre_imp$OCC.g100g_BULK*predictors_pre_imp$N.g100g_OCC + predictors_pre_imp$HF.g100g_BULK*predictors_pre_imp$N.g100g_HF)
prop_N_HF <- predictors_pre_imp$HF.g100g_BULK*predictors_pre_imp$N.g100g_HF/(predictors_pre_imp$FLF.g100g_BULK*predictors_pre_imp$N.g100g_FLF + predictors_pre_imp$OCC.g100g_BULK*predictors_pre_imp$N.g100g_OCC + predictors_pre_imp$HF.g100g_BULK*predictors_pre_imp$N.g100g_HF)

# ORIGINAL DATA: Remove variables

predictors_pre_imp_ref <- predictors_pre_imp[, -match(variables_remove, colnames(predictors_pre_imp))]

# ORIGINAL DATA: Combine predictors with proportion C and N in density fractions data

predictors_pre_imp_ref <- cbind(predictors_pre_imp_ref,
                                prop_C_FLF,
                                prop_C_OCC,
                                prop_C_HF,
                                prop_N_FLF,
                                prop_N_OCC,
                                prop_N_HF)

# ORIGINAL DATA: Add ".imp" and ".id" columns

original_imp <- rep(0, length(predictors_pre_imp_ref$site))

original_id <- seq(from = 1, to = length(predictors_pre_imp_ref$site), by = 1)

orignal_names <- colnames(predictors_pre_imp_ref)

predictors_pre_imp_ref <- cbind(original_imp,
                                original_id,
                                predictors_pre_imp_ref)

colnames(predictors_pre_imp_ref) <- c(".imp", ".id", orignal_names)

predictors_imp_processed <- rbind(predictors_pre_imp_ref, predictors_imp_stacked)

# Separate out response variables

response <- data[, c(match("site", colnames(data)):match("lab_ID", colnames(data)), match("t52_cumul_spec_resp_ugC_per_gC", colnames(data)))]

response_A <- subset(response, horizon_type %in% "A-Horizon")

response_B <- subset(response, horizon_type %in% "Upper B-Horizon")

# Match indices of response to imputed predictors

match_i <- rep(NA, length(predictors_imp_processed$site))  # Initialize index matching vector

for(i in 1:length(predictors_imp_processed$site)){

  j = 1  # Set counter index
  stop = 0  # Set stop index to initial value

  while(stop == 0){

    if(predictors_imp_processed$site[i] == response$site[j] & predictors_imp_processed$horizon_type[i] == response$horizon_type[j]){

      match_i[i] = j  # Record index value

      stop = 1  # Set stop index to stop value

    }else{

      j = j + 1  # Increment counter index

    }

  }

}

# Create data frame for CSR 0-52 weeks data

data_imp_CSR_0MST33 <- cbind(predictors_imp_processed[, match(".imp", colnames(predictors_imp_processed)):match("horizon_type", colnames(predictors_imp_processed))],
                             response$t52_cumul_spec_resp_ugC_per_gC[match_i],
                             predictors_imp_processed[, match("Incubation.Ambient.MST.class", colnames(predictors_imp_processed)):length(predictors_imp_processed)])

colnames(data_imp_CSR_0MST33)[5] <- "t52_cumul_spec_resp_ugC_per_gC"

# Create data frame for CSR 0-52 weeks data for A horizons

data_imp_CSR_0MST33_A <- subset(data_imp_CSR_0MST33, horizon_type %in% "A-Horizon")

col_A <- colnames(data_imp_CSR_0MST33_A)

col_A <- sub("response$t52_cumul_spec_resp_ugC_per_gC[match_i]", "t52_cumul_spec_resp_ugC_per_gC", col_A, fixed = TRUE)

colnames(data_imp_CSR_0MST33_A) <- col_A

data_imp_CSR_0MST33_A$.id <- data_imp_CSR_0MST33_A$.id - rep(seq(from = 0, to = 25, by = 1), times = 6)

# Create data frame for CSR 0-52 weeks data for B horizons

data_imp_CSR_0MST33_B <- subset(data_imp_CSR_0MST33, horizon_type %in% "Upper B-Horizon")

col_B <- colnames(data_imp_CSR_0MST33_B)

col_B <- sub("response$t52_cumul_spec_resp_ugC_per_gC[match_i]", "t52_cumul_spec_resp_ugC_per_gC", col_B, fixed = TRUE)

colnames(data_imp_CSR_0MST33_B) <- col_B

data_imp_CSR_0MST33_B$.id <- data_imp_CSR_0MST33_B$.id - rep(seq(from = 1, to = 26, by = 1), times = 6)

# Convert data frames to mids

data_imp_CSR_0MST33_mids <- as.mids(data_imp_CSR_0MST33)
data_imp_CSR_0MST33_A_mids <- as.mids(data_imp_CSR_0MST33_A)
data_imp_CSR_0MST33_B_mids <- as.mids(data_imp_CSR_0MST33_B)

# Save mids as .RData files

save(data_imp_CSR_0MST33_mids, file = "data_imp_CSR_0MST33_mids.RData")
save(data_imp_CSR_0MST33_A_mids, file = "data_imp_CSR_0MST33_A_mids.RData")
save(data_imp_CSR_0MST33_B_mids, file = "data_imp_CSR_0MST33_B_mids.RData")
